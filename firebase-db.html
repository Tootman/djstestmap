<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>
    <script src="richmondriverside.js"></script>
    <script src="ham-green-demo.js"></script>
    <script src="metajson.js"></script>
    <script>
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyB977vJdWTGA-JJ03xotQkeu8X4_Ds_BLQ",
        authDomain: "fir-realtime-db-24299.firebaseapp.com",
        databaseURL: "https://fir-realtime-db-24299.firebaseio.com",
        projectId: "fir-realtime-db-24299",
        storageBucket: "fir-realtime-db-24299.appspot.com",
        messagingSenderId: "546067641349"
    };
    firebase.initializeApp(config);
    </script>
</head>

<body>
    User id:
    <input type="text" name="id" id="user_id" /> User name:
    <input type="text" name="name" id="user_name" />
    <input type="email" name="email" id="email" />
    <input type="password" name="password" id="password" />
    <input type="button" value="save" onclick="save_user()" />
    <input type="button" value="update" onclick="update_user()" />
    <input type="button" value="delete" onclick="delete_user()" />
    <hr>
    <input type="button" value="retriveMapindex" onclick="retriveMapIndex()" />
    <input type="button" value="uploadMapData" onclick="retriveMapIndex()" />
    <input type="button" value="loadJSONFromFile" onclick="  loadJSONFromFile('ham-green-demo.json')" />
    <input type="button" value="Upload Related Data" onclick="uploadRelatedData()" />
    <input type="button" value="Create New DataRecord" onclick="createNewDataRecord()" />
    <input type="button" value="login" onclick="btnLogin()" />
    <input type="button" value="login out" onclick="btnLogout()" />
    <input type="button" value="Test related data " onclick="testRelatedData()" />
    <input type="button" value="Fetch once" onclick="fetchOnce()" />
    <div id="users_list"></div>
    <h2 id="">Map list </h2>
    <div id="maplist">
    </div>
    <script>
    // Get a reference to the database service
    const database = firebase.database();
    myOb = {}

    // literall writing to db: 
    //database.ref('users/settings').set({ color: 'red', size: 'large' })

    // literal reading database, using a callback on database data change
    // database.ref('users/').on('value', function(snapshot) {
    //     console.log(snapshot)
    //});

    // literal reading database, poling the datase for a snapshot
    //database.ref('/users/settings').once('value').then(function(snapshot) {
    //    console.log(snapshot.val().color)
    //});

    // retriveMapIndex()

    function fetchOnce() {
        nodePath = "App/RelatedData/-LBlxVOu7-67DEsWi7yP"
        database.ref(nodePath).once('value')
            .then(function(snapshot) {
                console.log("snap: ", snapshot)
                console.log("snap val: ", snapshot.val())
                myOb=snapshot.val()
            }).catch(function(error) {
                console.log("My Error: " + error.message);
            })
    }
    


    function retriveMapIndex() {
        database.ref('/App/Mapindex').once('value')
            .then(function(snapshot) {
                console.log(snapshot)
                console.log(snapshot.val())
                displayMapIndeces(snapshot)
            }).catch(function(error) {
                console.log("My Error: " + error.message);
            })
    }

    function displayMapIndeces(snapshot) {

        snapshot.val().forEach(
            function(item) {
                const btn = document.createElement("button")
                console.log(item.description)
                btn.setAttribute("value", item.name)
                btn.setAttribute("title", item.description)
                btn.innerHTML = item.name
                maplist.appendChild(btn);
            }
        )
    }


    function loadJSONFromFile(myFile) {
        fetch(myFile)
            .then(
                function(response) {
                    if (response.status !== 200) {
                        console.log('Looks like there was a problem. Status Code: ' +
                            response.status);
                        return;
                    }
                    response.json().then(function(data) {
                        console.log("ok - fetched!")
                        console.log("data");
                        sendToDB("/App/Maps", data)
                        return data;
                    })
                }
            )
            .catch(function(err) {
                console.log('Fetch Error :-S', err);
            });
    }

    function sendToDB(nodePath, data) {
        database.ref(nodePath).set({
            "1": data
        });
    }

    //loadJSONFromFile("ham-green-demo.json")

    function btnLogin() {
        const userEmail = document.getElementById('email').value
        const pass = document.getElementById('password').value
        console.log("note that hard code login has now been removed")
        firebase.auth().signInWithEmailAndPassword(userEmail, pass)
            .then(function(user) {
                console.log(user, "signed in!")
            })
            .catch(function(error) {
                console.log("sorry not signed in Error: " + error)

            });
    }


    function btnLogout() {
        firebase.auth().signOut().then(function() {
            // Sign-out successful.
            console.log("successfully signed out")
        }, function(error) {
            // An error happened.
            console.log("problem signing out - error: ", error)
        });
    }

    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            // User is signed in.
            var displayName = user.displayName;
            var email = user.email;
            var emailVerified = user.emailVerified;
            var photoURL = user.photoURL;
            var isAnonymous = user.isAnonymous;
            var uid = user.uid;
            var providerData = user.providerData;

            console.log("user status: " + displayName, email, uid, providerData)
            // ...
        } else {
            // User is signed out.
            // ...
            console.log("user not signed in")
        }
    });


    function writeData(nodePath) {
        // let userId = document.getElementById('user_id').value
        // let name = document.getElementById('user_name').value

        //
        database.ref(nodePath).set({
            username: name
        });
    }

    function readDataOnce() {
        let nodePath = '/users/settings'
        let myProperty = 'color'
        database.ref(nodePath).once('value').then(function(snapshot) {
            // console.log(snapshot.val().[myProperty])
            // eg console.log(snapshot.val().color)
        });
    }




    function pushUpOldestFirst(nodePath, data) {
        // takes in array of Related data to be pushed, reverses order then counts backwards
        // so that oldest data is processed first. It removes the successfully uploaded items from the array
        let d = data.reverse()
        console.log("length: " + d.length)
        for (i = d.length - 1; i >= 0; --i) {
            console.log("iterating: " + i)
            database.ref(nodePath).push(d[i])
                .then(function() {
                    d.splice(i, 1); // Remove item from list is successfully pushed
                })
                .catch(function(error) {
                    console.log("error in pushing to database: " + error)
                })
        }
        return d.reverse() // return the new list with any unpushed records in original order
    }

    /*
        function PushAllUnsyncedRelatedData(nodePath, data) {
            data.forEach(item) {
                database.ref(nodePath).push(item)
                .catch (function (error){
                    console.log("Error! " + error)
                })
            }
        }
        */

    var myList = [] // temp var to expose to global
    createNewDataRecord = function() {
        const rec = { myTimeStamp: Date() }
        myList.push(rec)
    }

    function uploadRelatedData() {
        const nodePath = "App/test/Maps/"
        //myList = pushUpOldestFirst(myList)
        myList = { timestamp: Date() }
        if (navigator.onLine === true) {
            myList = pushUpOldestFirst(nodePath, myList)
            console.log("navigator online")
        } else {
            console.log("sorry offline - try later")
        }

    }

    function onlineStatus(status) {
        AppOnline = true
    }


    function testRelatedData() {
        const nodePath = "App/test/Maps/djs/"
        let Ob = { myTimeStamp: Date() }
        database.ref(nodePath).push(Ob)
            .then(function() {
                console.log("ok pushed")
            })
            .catch(function(error) {
                console.log("error in pushing to database: " + error)
            })
    }


    window.addEventListener('online', function() { console.log("Online!") });
    window.addEventListener('offline', function() { console.log("Offline!") });
    </script>
</body>

</html>